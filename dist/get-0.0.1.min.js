(function(y,x){function s(n,q){var l=n.replace(/\/index$/,"");l!==n&&(z[l]=n);v[n]=v[l]=q}function A(n){if(!w[n]){var q="Could not load module: '"+n+"'";if(!v[n])throw Error(q);q={exports:w[n]={}};v[n](function(l){var a=z[n]||n,m=/(\.?\.\/?)*/.exec(l)[0],k=Math.floor(m.replace(/\//g,"").length/1.9+0.99);k&&(a=a.split("/"),a=a.slice(0,a.length-k),(a=a.join("/"))&&(l=a+"/"+l.slice(m.length)));l=l.replace(/\/$/,"");return A(l)},q.exports,q);w[n]=q.exports}return w[n]}function u(){}var w={},v={},z={};
s("src/curry",function(n,q,l){function a(k,e){var f=!1,b=function(){var b=Array.prototype.slice.call(arguments,0),e=this,c=[],t=!1;if(!f){for(var h=0;h<b.length;h++)m.equals(b[h])&&c.push(h);t=m.equals(b[b.length-1])}return 0===c.length||f?k.apply(e,b):a(function(){var h=Array.prototype.slice.call(arguments,0),r=c.length-(t?1:0);if(h.length<r)throw Error("Expect at least "+r+" arguments.");t&&b.pop();for(var a=0;a<h.length;a++)a<r?b[c[a]]=h[a]:b.push(h[a]);return k.apply(e,b)},!0)};b.uncurry=function(){if(!e)throw"Uncurry disabled.";
f=!0;return this};return b}var m=(y._||(y._={})).runid={equals:function(a){return a&&this===a.runid}};l.exports=a});u.define=s;u.require=A;"undefined"===typeof exports?window.get=u:module.exports=u;s("src/newparse",function(n,q,l){function a(a,k){return"function"!==typeof a?a:a(k)}l.exports=function(){};l.exports.tokenizer=function(m){var k=m.tokenize,e="",f;for(f in k)e&&(e+="|"),e+="(?:"+f+")",k[f].regex=new RegExp("^"+f+"$");e=new RegExp("("+e+")");return function(b){var d=[];b=b.split(e);console.log(b);
for(var g=0;g<b.length;g++){var c=b[g];if(0===g%2){if(""!==c)throw Error("Unexpected char(s): "+c);}else for(var t in k){var h=k[t];if(h.regex.test(c)){var p=a(h.type,c);if(a(h.invalid,c))throw Error("Invalid "+p+": "+c);d.push({type:p,token:c});break}}}return d}};l.exports.querylang={start:0,ended:[1,2],context:{result:[[]],last:function(){},add:function(a){}},tokenize:{"[=!<>~]+":{type:"operator",invalid:function(a){return!/^((===)|(!==)|(==)|(!==)|<|(<=)|>|(>=)|(~=))$/.test(a)}},"[A-Za-z0-9_\\-]+":{type:"name"},
"{{?":{type:"{"},"}}?":{type:"}"},":|#|\\[|\\]|\\.|\\*\\*?":{type:function(a){return a}},"\\s":{invalid:function(){throw Error("No whitespace allowed.");}}},states:{"0,1,**":function(){this.add({type:"**"})},"0,2,*":function(){this.add({type:"_",predicate:function(){return!0}})},"0,2,name":function(a){this.add({type:"_",name:a,predicate:function(a,e){return a===e}})},"0,3,:":null,"0,4,#":null,"0,6,[":null,"2,3,:":null,"2,4,#":null,"2,6,[":null,"2,0,.":null,"1,0,.":function(){result.push([])},"3,2,name":function(a){this.add({type:":",
name:a})},"4,2,name":function(a){this.add({type:"#",name:a})},"6,7,name":function(a){var k=this.last();k&&":"===k.type||this.add(k={});k.type=k.name||"[";k.name=a;k.predicate=function(a,f){return a!==x}},"7,8,operator":function(a){var k;switch(a){case "~=":k=function(a,f){return-1!==a.indexOf(f)};break;case "==":case "===":k=function(a,f){return a==f};break;case "!=":case "!==":k=function(a,f){return a!=f};break;case "<":k=function(a,f){return a<+f};break;case "<=":k=function(a,f){return a<=+f};break;
case ">":k=function(a,f){return a>+f};break;case ">=":k=function(a,f){return a>=+f}}this.last().predicate=k},"7,2,]":null,"8,9,{":null,"10,11,}":null,"9,10,name":function(a){this.last().value=function(k){return k(a)}},"8,11,name":function(a){this.last().value=function(k){return a}},"11,2,]":null}}});s("src/node",function(n,q,l){function a(c,b,h){this.children=b||new d.Array;this.nodedata=c||new a.DefaultData;this.timestamp=0;this.pending=[];this.detached=h||!1;this.creation=g.ascending()}function m(c){var a=
0,b=this;this.start=function(){a++};this.close=function(){0<a&&a--;0===a&&(a=-1,c&&c())};this.branch=function(c){var a=new m(function(){c&&c();b.close()});this.start();a.expired=this.expired;return a};this.expired=function(){return 0>a}}function k(c,a,h,p){p=new m(p);p.start();if(c.timestamp<h){c.timestamp=h;var r=new b(c,h,p);(a=a(r,c))&&c.pending.push({timestamp:h,operation:a})}p.close()}function e(c,a,b,p){(function B(d){var e=c.pending[d]||{},g=e.timestamp>b;c.pending.length<=d||g?p():k(a,e.operation,
e.timestamp,function(){B(d+1)})})(0)}function f(){throw Error("This reference has expired.");}function b(c,d,h){this.clone=function(){function b(c,h){var e=!d;h.cloned=!0;e=new a(h.nodedata,h.children,e);e.pending=h.pending;e.cloned=!0;d=e;return b}h.expired()&&f();var d;k(c,b,g.ascending(),function(){});return new Root(d)};this.isRoot=function(){h.expired()&&f();return c.detached};this.isInfinite=function(){h.expired()&&f();return!!(c.children||{}).infinite};this.set=function(a,b,d){h.expired()&&
f();if(!c.nodedata[a])throw Error("Unknown type.");return c.nodedata[a].set(b,d)};this.get=function(a,b){h.expired()&&f();if(!c.nodedata[a])throw Error("Unknown type.");return c.nodedata[a].get(b)};this.all=function(a){h.expired()&&f();if(!c.nodedata[a])throw Error("Unknown type.");return c.nodedata[a].clone(!0)};this.next=function(a,g,k,m){h.expired()&&f();h.start();var l,n,q=h.branch(function(){m&&m(l,n);h.close()});q.start();c.children.next(a,g,function(a,h,g,p){p||a?(l=a,n=p,q.close()):e(c,g,
d,function(){k(new b(g,d,q),h);q.close()})})};this.find=function(a,g,k,m){h.expired()&&f();if(this.isInfinite())m&&m(null,{length:0});else{h.start();var l,n,q=h.branch(function(){m&&m(l,n);h.close()});q.start();(function C(a){c.children.next(a,g,function(a,h,g,p){p||a?(l=a,n=p,q.close()):e(c,g,d,function(){k(new b(g,d,q),h);C(h+1)})})})(a)}}}var d=n("./stream"),g={current:1,ascending:function(){return g.current++}};a.prototype.onchange=function(){if(this.cloned){var a={},b;for(b in this.nodedata)a[b]=
this.nodedata[b].clone();for(var h in this.pending);this.nodedata=a;this.cloned=!1}};a.KeyValue=function(c){var b=c||{};this.set=function(a,c){return b[a]=c};this.get=function(a){return b[a]};this.clone=function(c){var d={},e;for(e in b)d[e]=b[e];return c?d:new a.KeyValue(d)}};a.DefaultData=function(){this.attr=new a.KeyValue;this.prop=new a.KeyValue;this.path=new a.KeyValue;this.tags=new a.KeyValue;this.text=new a.KeyValue;this.mark=new a.KeyValue};a.Root=function(a){a.detached=!0;this.execute=function(b,
h){a.detached||f();k(a,b,g.ascending(),h)}};l.exports=a});s("src/parse",function(n,q,l){function a(a){this.original=a}a.tokenize=function(m,k){var e=0;return new a(m.match(k).map(function(a){var b={data:a,pos:e,assert:function(a,b){var c=this.data;if("name"===a){if(c.name||-1==="#:[]=!<>.*{}".indexOf(c[0]))return!0}else if(c===a)return!0;if(b)return!1;throw Error(['Unexpected symbol "'+c+'" ','expected "'+a+'" ',"at column: "+this.pos].join(""));}};e+=a.length;return b}))};a.prototype.parse=function(m){var k,
e=0,f=new a(this.original.map(function(a,d){if(!a)return a;var g=!1,c=m.call({setState:function(a){e=a},setCurrent:function(a){k=a},remove:function(){g=!0},expected:function(c,h){return a.assert(c,h)}},a.data,e,k);return g?null:{data:c,pos:a.pos,assert:a.assert}}));if(0<e)throw Error("Unexpected ending.");return f};l.exports=function(m){var k=[[]];a.tokenize(m,/\#|\:|\[|\]|[\=\!<>]+|\{|\}|\*+|\.|[^\#\:\[\]\=\!<>\{\}\*\.]+/g).parse(function(a,f,b){var d;switch(f){case 0:if("*"===a[0]){d={wildcard:a.length};
break}else if(this.expected("name",!0)){d={constant:a};break}else if("{"===a)this.setState(1);else return this.setCurrent(null),a;break;case 1:this.expected("{");this.setState(2);break;case 2:this.expected("name");d={breakets:a};this.setState(3);break;case 3:this.expected("}");this.setState(4);break;case 4:this.expected("}"),this.setState(0)}if(b)this.remove(),d&&b.push(d);else return this.setCurrent(b=d?[d]:[]),{name:b}}).parse(function(a,f,b){var d;switch(f){case -1:if("["===a){this.setState(3);
break}case 0:if(a.name)d={type:"_",name:a.name};else{switch(a){case ".":return a;case "#":this.setState(1);break;case ":":this.setState(2);break;case "[":this.setState(3);break;default:this.expected("#, : or [")}d={type:a}}break;case 1:case 2:this.expected("name");b.name=a.name;this.setState(1===f?0:-1);break;case 3:this.expected("name");b.prop=a.name;this.setState(4);break;case 4:-1!=="=!<>".indexOf(a[0])?(b.assert=a,this.setState(5)):(this.expected("]"),this.setState(0));break;case 5:this.expected("name");
b.value=a.name;this.setState(6);break;case 6:this.expected("]"),this.setState(0)}if(d)return this.setCurrent(d),d;this.remove()}).parse(function(a){"."===a?k.push([]):k[k.length-1].push(a)});return k}});s("src/query",function(n,q,l){function a(){this.root=null;this.traces=[]}function m(a,d,g,c,e){var h;switch(g){case "in":h=function(a,c){return-1!==a.indexOf(c)};break;case "==":case "===":h=function(a,c){return a==c};break;case "!=":case "!==":h=function(a,c){return a!=c};break;case "<":h=function(a,
c){return a<+c};break;case "<=":h=function(a,c){return a<=+c};break;case ">":h=function(a,c){return a>+c};break;case ">=":h=function(a,c){return a>=+c};break;case null:h=function(a,c){return a!==x};break;default:throw Error("Unknown operator "+g);}g=1===c.length&&c[0].breakets?e(c[0].breakets):g?k(c,e):null;return new f.Assertion(a,d,h,g)}function k(a,d){var g="",c;for(c in a)if(a[c].breakets)g+=d(a[c].breakets);else if(a[c].constant)g+=a[c].constant;else if(a[c].wildcard)throw Error("* not supported here.");
return g}function e(a,d){var g=[];a.map(function(a){if("_"===(a[0]||{}).type&&1===(a[0].name||{}).wildcard)g.push(f.Assertion.truthy);else{var b,h,d=null,e;switch(a.type){case "_":b="tags";h="name";d="==";e=a.name;break;case "#":b="attr";h="id";d="==";e=a.name;break;case "[":b="prop";h=a.prop;a.assert&&(d=a.assert,e=a.value);break;case ":":a.prop?(b=a.name,h=a.prop,a.assert&&(d=a.assert,e=a.value)):(b="attr",h="class",d="in",e=a.name)}g.push(m(b,h,d,e))}});return new f.DNF(g)}n("./parse");var f=n("./state");
a.buildStateMachine=function(a,d){var g;a.map(function(a){var b=new f.States;a.map(function(a,c){if(1===a.length&&"_"===(a[0]||{}).type&&2===(a[0].name||{}).wildcard){var d=f.Assertion.truthy;b.addTransition(c,c+1,d);b.addTransition(c,c,d)}else d=e(a),b.addTransition(c,c+1,d)});b.setEndState(a.length);g?g.or(b):g=new f.DNF([b])});return g};a.prototype.get=function(){};a.prototype.has=function(){};a.prototype.from=function(){};a.prototype.each=function(){};a.prototype.live=function(){};l.exports=a});
s("src/state",function(n,q,l){function a(a,f){this.terms=[{truthy:a||[],falsey:f||[]}]}function m(a,f,b,d){this.resolve=function(g){return b(d,g.get(a,f))}}function k(a,f,b){a=a||[0];f=f||{};b=b||{};this.addTransition=function(a,b,c){f[a]||(f[a]=[]);f[a].push({next:b,dnfa:c})};this.setEndState=function(a){b[a]=!0};this.resolve=function(){for(var d=0;d<a.length;d++)if(b[a[d]])return!0;return!1};this.transition=function(d){if(0===a.length)return this;for(var g={},c=[],t=0;t<a.length;t++)for(var h=f[a[t]]||
[],p=0;p<h.length;p++)if(h[p].dnfa.resolve(d)){var r=h[p].next;g[r]||(g[r]=!0,c.push(r))}return new k(c,f,b)}}a.prototype.or=function(e){e instanceof a||(e=new a([e]));this.terms=this.terms.concat(e.terms);return this};m.truthy={resolve:function(){return!0}};a.prototype.resolve=function(a){for(var f=!1,b=0;b<this.terms.length;b++){for(var d=!0,g=this.terms[b].truthy,c=this.terms[b].falsey,k=0;k<g.length;k++)d&=g[k].resolve(a);for(g=0;g<c.length;g++)d&=!c[g].resolve(a);d&&(f=!0)}return f};a.prototype.transition=
function(e){function f(a){for(var c=[],b=0;b<a.length;b++)c[b]=a[b].transition(e);return c}for(var b=new a,d=0;d<this.terms.length;d++)b.terms[d]={truthy:f(this.terms[d].truthy),falsey:f(this.terms[d].falsey)};return b};l.exports.States=k;l.exports.DNF=a;l.exports.Assertion=m});s("src/static",function(n,q,l){function a(a,b){for(var d in a)a.hasOwnProperty(d)&&b(d,a[d],!1)}function m(a){return"string"!==typeof a&&"number"===typeof a.length}function k(a,b,d,g){for(var e=0;e<a.length;e++){var f=b.slice(0);
f.push(e);d&&m(a[e])?k(a[e],f,d,g):g(f,a[e],!0)}}function e(b,f){function h(a,b,c){var d=e(b);d?(d.nodedata.tags.set(c?"index":"name",a),r.push(d)):p.prop.set(a,b)}var p=new g.DefaultData,r=[];if(m(b))p.tags.set("array",!0),k(b,[],f,h);else if(b.constructor===Object)a(b,h);else return null;return new g(p,new d.Array(r))}function f(a,b,d,g){function e(a){f.length<=a+1?d[f[a]]=b:(d[f[a]]=[],e(a+1))}var f=a.get("tags","index");f&&"number"===typeof f[0]?e(0):g.push(b)}function b(a,d){var h=a.get("tags",
"array"),g=[],e=h?[]:{};a.find(0,null,function(a){b(a,function(b){if(h)f(a,b,e,g);else{var c=e,d=a.get("tags","name");d?c[d]=b:g.push(b)}})},function(){h&&(e=e.concat(g));var b=a.all("prop"),f;for(f in b)e[f]=b[f];d(e)})}var d=n("./stream"),g=n("./node");l.exports=function(a){a.read=function(a,b){b||(b={});var c=b.type?b.type.toLowerCase():"";if(!c||"js"===c){c=e(a,!!b.flatten);if(!c)throw Error("Expected toplevel array or object.");return new g.Root(c)}};a.toJS=function(a,c){a.execute(function(a){b(a,
function(a){c(a)})})}}});s("src/stream",function(n,q,l){function a(a){this.infinite=!!a}function m(a,d){this.original=a;this.extend=d}function k(a,d){this.original=a;this.stream=d}function e(a,d,g,c){this.reduced=new m(a,-d);this.count=g;this.fill=c}a.prototype.next=function(a,d,g){throw Error("Not implemented.");};a.Array=function(a){!a||a instanceof Array||(a=[a]);this.elements=a||[]};a.Array.prototype=new a;a.Array.prototype.next=function(a,d,g){a>=this.elements.length?g(null,a,null,{length:this.elements.length}):
(d=this.elements[a],this.mapper&&(d=this.mapper(d)),g(null,a,d))};m.prototype=new a;m.prototype.next=function(a,d,g){var c=this;this.original.next(a-this.extend,d,function(a,b,d,e){e&&(e.length+=c.extend);g(a,b+c.extend,d,e)})};(function(a,d){this.next=function(a,b,e){this.original.next(a,b,function(a,b,c,g){c&&d(c);e(a,b,c,g)})}}).prototype=new a;k.prototype=new a;k.prototype.next=function(a,d,e){var c=this;this.original.next(a,d,function(f,h,k,l){if(f)return e(f);l?(c.offset||(c.offset=new m(c.stream,
l.length)),c.offset.next(a,d,e)):e(f,h,k,null)})};e.prototype=new a;e.prototype.next=function(a,d,e){if(a>=this.count&&this.fill)return e(null,null,null,{length:this.count});var c=this;this.reduced.next(a,d,function(a,b,d,f){if(a)return e(a);(!f||c.fill)&&b>=c.count?e(a,null,null,{length:c.count}):c.fill&&f?e(a,b,x,null):e(a,b,d,f)})};var f=Number.POSITIVE_INFINITY;a.prototype.append=function(b){b instanceof a||(b=new a.Array(b));return new k(this,b)};a.prototype.map=function(b){return new a.Mapper(this,
b)};a.prototype.prepend=function(b,d){d instanceof a||(d=new a.Array(d));var g=new e(this,0,b,!0),c=new e(this,b,f);return new k(g,new k(d,c))};a.prototype.detach=function(a,d){var g=new e(this,0,a,!0),c=new e(this,a+d,f);return{target:new k(g,c),result:new e(this,a,d)}};l.exports=a});u.require("src/static")(u)})(Function("return this")());
