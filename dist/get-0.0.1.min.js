(function(x,w){function r(l,q){var p=l.replace(/\/index$/,"");p!==l&&(y[p]=l);u[l]=u[p]=q}function z(l){if(!v[l]){var q="Could not load module: '"+l+"'";if(!u[l])throw Error(q);q={exports:v[l]={}};u[l](function(p){var a=y[l]||l,n=/(\.?\.\/?)*/.exec(p)[0],f=Math.floor(n.replace(/\//g,"").length/1.9+0.99);f&&(a=a.split("/"),a=a.slice(0,a.length-f),(a=a.join("/"))&&(p=a+"/"+p.slice(n.length)));p=p.replace(/\/$/,"");return z(p)},q.exports,q);v[l]=q.exports}return v[l]}function t(){}var v={},u={},y={};
r("src/curry",function(l,q,p){function a(f,d){var e=!1,b=function(){var b=Array.prototype.slice.call(arguments,0),d=this,k=[],m=!1;if(!e){for(var h=0;h<b.length;h++)n.equals(b[h])&&k.push(h);m=n.equals(b[b.length-1])}return 0===k.length||e?f.apply(d,b):a(function(){var h=Array.prototype.slice.call(arguments,0),a=k.length-(m?1:0);if(h.length<a)throw Error("Expect at least "+a+" arguments.");m&&b.pop();for(var e=0;e<h.length;e++)e<a?b[k[e]]=h[e]:b.push(h[e]);return f.apply(d,b)},!0)};b.uncurry=function(){if(!d)throw"Uncurry disabled.";
e=!0;return this};return b}var n=(x._||(x._={})).runid={equals:function(a){return a&&this===a.runid}};p.exports=a});t.define=r;t.require=z;"undefined"===typeof exports?window.get=t:module.exports=t;r("src/node",function(l,q,p){function a(b,h,c){this.children=h||new g.Array;this.nodedata=b||new a.DefaultData;this.timestamp=0;this.pending=[];this.detached=c||!1;this.creation=k.ascending()}function n(b){var h=0,c=this;this.start=function(){h++};this.close=function(){0<h&&h--;0===h&&(h=-1,b&&b())};this.branch=
function(b){var m=new n(function(){b&&b();c.close()});this.start();m.expired=this.expired;return m};this.expired=function(){return 0>h}}function f(b,h){b.cloned=!0;var c=new a(b.nodedata,b.children,h);c.pending=b.pending.slice(0);c.cloned=!0;return c}function d(b,h,d,a){a=new n(a);a.start();if(b.timestamp<d){b.timestamp=d;var e=new c(b,d,a);(h=h(e,b))&&b.pending.push({timestamp:d,operation:h})}a.close()}function e(b,h,c,a){(function A(e){var k=b.pending[e]||{},f=k.timestamp>c;b.pending.length<=e||
f?a():d(h,k.operation,k.timestamp,function(){A(e+1)})})(0)}function b(){throw Error("This reference has expired.");}function c(m,h,k){function g(b,a,d,f){k.start();var s,n,l=k.branch(function(){f&&f(s,n);k.close()});l.start();b(function(b,k,f,g){g||b?(s=b,n=g,l.close()):e(m,f,h,function(){d(new c(f,h,l),k);a(l)})})}this.clone=function(){k.expired()&&b();var c;d(m,function(b,k){c=f(k,!0);return function(b,c){f(c);return recursive}},h);return new a.Root(c)};this.internal=function(){return m};this.isRoot=
function(){k.expired()&&b();return m.detached};this.isInfinite=function(){k.expired()&&b();return!!(m.children||{}).infinite};this.set=function(c,h,a){k.expired()&&b();if(!m.nodedata[c])throw Error("Unknown type.");m.onchange();return m.nodedata[c].set(h,a)};this.get=function(c,h){k.expired()&&b();if(!m.nodedata[c])throw Error("Unknown type.");return m.nodedata[c].get(h)};this.all=function(c){k.expired()&&b();if(!m.nodedata[c])throw Error("Unknown type.");return m.nodedata[c].clone(!0)};this.next=
function(c,h,a,d){k.expired()&&b();g(function(b){m.children.next(c,h,b)},function(b){b.close()},a,d)};this.find=function(c,h,a,d){k.expired()&&b();if(this.isInfinite())d&&d(null,{length:0});else{var e;g(function(b){e=function(){m.children.next(c,h,b)};e()},function(){c+=1;e()},a,d)}}}var g=l("./stream"),k={current:1,ascending:function(){return k.current++}};a.prototype.onchange=function(){console.log(JSON.stringify(this));console.log(this.nodedata.tags.get("name"));if(this.cloned){console.log("!!!!!!!");
var b={},c;for(c in this.nodedata)b[c]=this.nodedata[c].clone();for(var a in this.pending);this.nodedata=b;this.cloned=!1}};a.KeyValue=function(b){var c=b||{};this.set=function(b,a){return c[b]=a};this.get=function(b){return c[b]};this.clone=function(b){var k={},d;for(d in c)k[d]=c[d];return b?k:new a.KeyValue(k)}};a.DefaultData=function(){this.attr=new a.KeyValue;this.prop=new a.KeyValue;this.path=new a.KeyValue;this.tags=new a.KeyValue;this.text=new a.KeyValue;this.mark=new a.KeyValue};a.Root=function(c){c.detached=
!0;this.execute=function(a,e){c.detached||b();d(c,a,k.ascending(),e)}};p.exports=a});r("src/parser",function(l,q,p){function a(a,b,c){return"function"!==typeof a?a:a.call(c,b)}function n(d,b){return{resolve:function(c){if(c.type!==b)return!1;a(d,c.token,c.context);return!0}}}function f(d){var b=d.tokenize,c="",f;for(f in b)c&&(c+="|"),c+="(?:"+f+")",b[f].regex=new RegExp("^"+f+"$");c=new RegExp("("+c+")");return function(d){var e=[];d=d.split(c);for(var h=0;h<d.length;h++){var f=d[h];if(0===h%2){if(""!==
f)throw Error("Unexpected char(s): "+f);}else for(var g in b){var l=b[g];if(l.regex.test(f)){var n=a(l.type,f);if(a(l.invalid,f))throw Error("Invalid "+n+": "+f);e.push({type:n,token:f});break}}}return e}}var d=l("./state");p.exports=function(a){var b=f(a),c=new d.States,g;for(g in a.endStates)c.setEndState(a.endStates[g]);for(var k in a.states){g=k.split(",");var m=n(a.states[k],g[2]);c.addTransition(g[0],g[1],m)}return function(d){d=b(d);var k=c,f=a.context(),m;for(m in d){var g=d[m];g.context=
f;k=k.transition(g);if(k.isDone())throw Error("Unexpected token: "+g.token);}if(!k.resolve())throw Error("Unexpected end of input string.");return f.value()}}});r("src/public",function(l,q,p){function a(){this.root=null;this.query=new n}var n=l("./query");a.prototype.get=function(){this.query.concat(new n(arguments));return this};a.prototype.has=function(){this.query.concat(new n(arguments,{isHas:!0}));return this};a.prototype.from=function(a){this.root=a;return this};a.prototype.each=function(a){if(this.query.matchesRoot())this.root.execute(function(d){a(d)});
else{var d=this.query.buildStateMachine();this.root.execute(function(){return function b(c){d=d.transition(c);d.resolve()&&a(c);if(!d.isDone())return b}})}};a.prototype.live=function(a,d){};p.exports=a});r("src/query",function(l,q,p){function a(f,d){this.traces=[];this.option=d||{};for(var e=0;e<(f||[]).length;e++){var b=f[e];"string"===typeof b&&(b=a.parser(b));this.traces.push(b)}}q=l("./parser");var n=l("./state");a.parser=q({endStates:[1,2],context:function(){var a={result:[[]],last:function(){var d=
a.result[a.result.length-1];if(0!==d.length)return d[d.length-1]},add:function(d){a.result[a.result.length-1].push(d)},value:function(){return a.result}};return a},tokenize:{"[=!<>~]+":{type:"operator",invalid:function(a){return!/^((===)|(!==)|(==)|(!==)|<|(<=)|>|(>=))$/.test(a)}},"[A-Za-z0-9_\\-]+":{type:"name"},"{{?":{type:"{"},"}}?":{type:"}"},":|#|\\[|\\]|\\.|\\*\\*?":{type:function(a){return a}},"\\s":{invalid:function(){throw Error("No whitespace allowed.");}}},states:{"0,1,**":function(){this.result[this.result.length-
1]={type:"**"}},"0,2,*":function(){this.add({type:"_",predicate:function(){return!0}})},"0,2,name":function(a){this.add({type:"_",value:a,predicate:function(a,e){return a===e}})},"0,3,:":null,"0,4,#":null,"0,6,[":null,"2,3,:":null,"2,4,#":null,"2,6,[":null,"2,0,.":function(){this.result.push([])},"1,0,.":function(){this.result.push([])},"3,2,name":function(a){this.add({type:":",value:a})},"4,2,name":function(a){this.add({type:"#",value:a,predicate:function(a,e){return a!==w}})},"6,7,name":function(a){var d=
this.last();d&&":"===d.type||this.add(d={});d.type=d.value||"[";d.name=a;d.predicate=function(a,b){return a!==w}},"7,8,operator":function(a){var d;switch(a){case "==":case "===":d=function(a,b){return a==b};break;case "!=":case "!==":d=function(a,b){return a!=b};break;case "<":d=function(a,b){return a<+b};break;case "<=":d=function(a,b){return a<=+b};break;case ">":d=function(a,b){return a>+b};break;case ">=":d=function(a,b){return a>=+b}}this.last().predicate=d},"7,2,]":null,"8,9,{":null,"10,11,}":null,
"9,10,name":function(a){var d=this.last();d.value=a;d.lookup=!0},"8,11,name":function(a){this.last().value=a},"11,2,]":null}});a.prototype.matchesRoot=function(){return 0===this.traces.length};a.prototype.normalizeAssertion=function(a,d){var e=a.type,b=a.name,c=a.predicate,g=a.value;switch(e){case "_":e="tags";b="name";break;case ":":e="attr";b="class";c=function(a,b){return-1!==a.indexOf(b)};break;case "#":e="attr";b="id";break;case "[":e="attr"}a.lookup&&(g=d.get(g));return new n.Assertion(e,b,
c,g)};a.prototype.buildStateMachine=function(a){function d(b){return e.normalizeAssertion(b,a)}for(var e=this,b,c=0;c<this.traces.length;c++){var g=new n.States,k=this.traces[c];g.setEndState(k.length);for(var m=0;m<k.length;m++){var h=k[m];"**"===h.type?(h=n.Assertion.truthy,g.addTransition(m,m,h)):h=new n.DNF(h.map(d));g.addTransition(m,m+1,h)}b?b.or(g):b=new n.DNF([g])}return b};a.prototype.concat=function(a){a.option.isHas?this.matchesRoot():this.matchesRoot()&&(this.traces=a.traces)};p.exports=
a});r("src/state",function(l,q,p){function a(a,e){this.terms=[{truthy:a||[],falsey:e||[]}]}function n(a,e,b,c){this.resolve=function(g){return b(c,g.get(a,e))}}function f(a,e,b){a=a||[0];e=e||{};b=b||{};this.addTransition=function(a,b,d){e[a]||(e[a]=[]);e[a].push({next:b,dnfa:d})};this.setEndState=function(a){b[a]=!0};this.resolve=function(){for(var c=0;c<a.length;c++)if(b[a[c]])return!0;return!1};this.isDone=function(){return 0===a.length};this.transition=function(c){if(0===a.length)return this;
for(var g={},k=[],m=0;m<a.length;m++)for(var h=e[a[m]]||[],l=0;l<h.length;l++)if(h[l].dnfa.resolve(c)){var s=h[l].next;g[s]||(g[s]=!0,k.push(s))}return new f(k,e,b)}}a.prototype.or=function(d){d instanceof a||(d=new a([d]));this.terms=this.terms.concat(d.terms);return this};n.truthy={resolve:function(){return!0}};a.prototype.resolve=function(a){for(var e=!1,b=0;b<this.terms.length;b++){for(var c=!0,g=this.terms[b].truthy,k=this.terms[b].falsey,m=0;m<g.length;m++)c&=g[m].resolve(a);for(g=0;g<k.length;g++)c&=
!k[g].resolve(a);c&&(e=!0)}return e};a.prototype.transition=function(d){function e(a){for(var b=[],c=0;c<a.length;c++)b[c]=a[c].transition(d);return b}for(var b=new a,c=0;c<this.terms.length;c++)b.terms[c]={truthy:e(this.terms[c].truthy),falsey:e(this.terms[c].falsey)};return b};a.prototype.isDone=function(a){return!1};p.exports.States=f;p.exports.DNF=a;p.exports.Assertion=n});r("src/static",function(l,q,p){function a(a,b){for(var c in a)a.hasOwnProperty(c)&&b(c,a[c],!1)}function n(a){return"string"!==
typeof a&&"number"===typeof a.length}function f(a,b,c,d){for(var g=0;g<a.length;g++){var e=b.slice(0);e.push(g);c&&n(a[g])?f(a[g],e,c,d):d(e,a[g],!0)}}function d(b,e){function h(a,b,c){var h=d(b);h?(h.nodedata.tags.set(c?"index":"name",a),s.push(h)):l.prop.set(a,b)}var l=new g.DefaultData,s=[];if(n(b))l.tags.set("array",!0),f(b,[],e,h);else if(b.constructor===Object)a(b,h);else return null;return new g(l,new c.Array(s))}function e(a,b,c,d){function g(a){e.length<=a+1?c[e[a]]=b:(c[e[a]]=[],g(a+1))}
var e=a.get("tags","index");e&&"number"===typeof e[0]?g(0):d.push(b)}function b(a,c){var d=a.get("tags","array"),g=[],f=d?[]:{};a.find(0,null,function(a){b(a,function(b){if(d)e(a,b,f,g);else{var c=f,k=a.get("tags","name");k?c[k]=b:g.push(b)}})},function(){d&&(f=f.concat(g));var b=a.all("prop"),e;for(e in b)f[e]=b[e];c(f)})}var c=l("./stream"),g=l("./node");p.exports=function(a){a.read=function(a,b){b||(b={});var c=b.type?b.type.toLowerCase():"";if(!c||"js"===c){c=d(a,!!b.flatten);if(!c)throw Error("Expected toplevel array or object.");
return new g.Root(c)}};a.toJS=function(a,c){a.execute(function(a){b(a,function(a){c(a)})})}}});r("src/stream",function(l,q,p){function a(a){this.infinite=!!a}function n(a,c){this.original=a;this.extend=c}function f(a,c){this.original=a;this.stream=c}function d(a,c,d,e){this.reduced=new n(a,-c);this.count=d;this.fill=e}a.prototype.next=function(a,c,d){throw Error("Not implemented.");};a.Array=function(a){!a||a instanceof Array||(a=[a]);this.elements=a||[]};a.Array.prototype=new a;a.Array.prototype.next=
function(a,c,d){a>=this.elements.length?d(null,a,null,{length:this.elements.length}):(c=this.elements[a],this.mapper&&(c=this.mapper(c)),d(null,a,c))};n.prototype=new a;n.prototype.next=function(a,c,d){var e=this;this.original.next(a-this.extend,c,function(a,b,c,f){f&&(f.length+=e.extend);d(a,b+e.extend,c,f)})};(function(a,c){this.next=function(a,b,d){this.original.next(a,b,function(a,b,e,g){e&&c(e);d(a,b,e,g)})}}).prototype=new a;f.prototype=new a;f.prototype.next=function(a,c,d){var e=this;this.original.next(a,
c,function(f,h,l,p){if(f)return d(f);p?(e.offset||(e.offset=new n(e.stream,p.length)),e.offset.next(a,c,d)):d(f,h,l,null)})};d.prototype=new a;d.prototype.next=function(a,c,d){if(a>=this.count&&this.fill)return d(null,null,null,{length:this.count});var e=this;this.reduced.next(a,c,function(a,b,c,f){if(a)return d(a);(!f||e.fill)&&b>=e.count?d(a,null,null,{length:e.count}):e.fill&&f?d(a,b,w,null):d(a,b,c,f)})};var e=Number.POSITIVE_INFINITY;a.prototype.append=function(b){b instanceof a||(b=new a.Array(b));
return new f(this,b)};a.prototype.map=function(b){return new a.Mapper(this,b)};a.prototype.prepend=function(b,c){c instanceof a||(c=new a.Array(c));var g=new d(this,0,b,!0),k=new d(this,b,e);return new f(g,new f(c,k))};a.prototype.detach=function(a,c){var g=new d(this,0,a,!0),k=new d(this,a+c,e);return{target:new f(g,k),result:new d(this,a,c)}};p.exports=a});t.require("src/static")(t)})(Function("return this")());
